<% 
  title = 'Чат #' + orderId + ' - Wayfis';
  layout('layout');
%>

<div class="card">
  <div class="chat-container" id="chatMessages">
    <% messages.forEach(msg => { %>
      <div class="message <%= msg.sender === 'admin' ? 'admin-message' : 'user-message' %>">
        <div><%= msg.text %></div>
        <small style="color: var(--text-secondary); font-size: 0.75rem;">
          <%= new Date(msg.created_at).toLocaleTimeString() %>
        </small>
      </div>
    <% }); %>
  </div>

  <form action="/chat/<%= orderId %>/send" method="POST" style="margin-top: 16px; display: flex; gap: 8px;">
    <input type="text" name="message" class="form-input" placeholder="Напишите сообщение..." required>
    <button type="submit" class="btn btn-primary">Отправить</button>
  </form>

  <form action="/chat/<%= orderId %>/close" method="POST" style="margin-top: 16px;">
    <button type="submit" class="btn btn-danger">Закрыть заказ</button>
  </form>
</div>

<script>
  const socket = io();
  const orderId = '<%= orderId %>';
  socket.emit('join-chat', orderId);

  socket.on('new-message', (msg) => {
    const messagesDiv = document.getElementById('chatMessages');
    const div = document.createElement('div');
    div.className = `message ${msg.sender === 'admin' ? 'admin-message' : 'user-message'}`;
    div.innerHTML = `
      <div>${msg.text}</div>
      <small style="color: var(--text-secondary); font-size: 0.75rem;">${msg.time}</small>
    `;
    messagesDiv.appendChild(div);
    messagesDiv.scrollTop = messagesDiv.scrollHeight;
  });
</script>