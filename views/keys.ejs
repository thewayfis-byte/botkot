<% 
  title = 'Ключи - Wayfis';
  layout('layout');
%>

<div class="card">
  <div class="card-header">
    <h2 class="card-title">Управление ключами</h2>
    <button onclick="document.getElementById('addModal').classList.remove('hidden')" class="btn btn-primary">+ Добавить</button>
  </div>

  <table class="table">
    <thead>
      <tr>
        <th>Ключ</th>
        <th>Товар</th>
        <th>Статус</th>
      </tr>
    </thead>
    <tbody>
      <% keys.forEach(key => { %>
        <tr>
          <td><code><%= key.key_value %></code></td>
          <td><%= key.product_name %></td>
          <td>
            <span class="status <%= key.is_used ? 'status-error' : 'status-success' %>">
              <%= key.is_used ? 'Использован' : 'Доступен' %>
            </span>
          </td>
        </tr>
      <% }); %>
    </tbody>
  </table>
</div>

<!-- Модальное окно добавления -->
<div id="addModal" class="hidden" style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); display: flex; align-items: center; justify-content: center;">
  <div class="card" style="width: 500px; max-width: 90vw;">
    <h3 class="card-title">Добавить ключ</h3>
    <form method="POST" action="/keys">
      <div class="form-group">
        <label class="form-label">Товар</label>
        <select name="product_id" class="form-select" required>
          <% products.forEach(p => { %>
            <option value="<%= p.id %>"><%= p.name %></option>
          <% }); %>
        </select>
      </div>
      <div class="form-group">
        <label class="form-label">Ключ</label>
        <input name="key_value" class="form-input" placeholder="XXXXX-XXXXX-XXXXX" required>
      </div>
      <div class="card-actions">
        <button type="button" onclick="document.getElementById('addModal').classList.add('hidden')" class="btn btn-outline">Отмена</button>
        <button type="submit" class="btn btn-primary">Добавить</button>
      </div>
    </form>
  </div>
</div>

<script>
  // Скрытие модального окна при клике вне его
  document.addEventListener('click', (e) => {
    const modal = document.getElementById('addModal');
    if (e.target === modal) {
      modal.classList.add('hidden');
    }
  });
</script>